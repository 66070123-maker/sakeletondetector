import cv2
import mediapipe as mp
import math
import threading
import winsound
import time
import datetime
import os
from openpyxl import Workbook, load_workbook
from openpyxl.styles import PatternFill
from win10toast import ToastNotifier

# ------------------- ฟังก์ชันคำนวณมุม -------------------
def calculate_angle(a, b, c):
    """ a,b,c = (x, y) """
    ba = (a[0]-b[0], a[1]-b[1])
    bc = (c[0]-b[0], c[1]-b[1])
    dot = ba[0]*bc[0] + ba[1]*bc[1]
    mag_ba = math.hypot(ba[0], ba[1])
    mag_bc = math.hypot(bc[0], bc[1])
    angle_rad = math.acos(dot / (mag_ba * mag_bc + 1e-7))
    return math.degrees(angle_rad)

# ------------------- ตั้งค่า MediaPipe -------------------
mp_drawing = mp.solutions.drawing_utils
mp_pose = mp.solutions.pose

cap = cv2.VideoCapture(0, cv2.CAP_DSHOW) 
cv2.namedWindow("Ergonomics Pose Detector", cv2.WINDOW_NORMAL)
cv2.setWindowProperty("Ergonomics Pose Detector", cv2.WND_PROP_TOPMOST, 1) # บังคับเด้งมาข้างหน้า

with mp_pose.Pose(min_detection_confidence=0.5, min_tracking_confidence=0.5) as pose:
    # alarm state to avoid repeated triggers
    alarm_active = False
    notification_shown = False
    toaster = ToastNotifier()

    # Excel export setup
    excel_path = os.path.join(os.path.dirname(__file__), "posture_log.xlsx")
    header = [
        "DateTime",
        "Seconds",
        "Score",
        "Knee_Angle",
        "Knee_Status",
        "Hip_Angle",
        "Hip_Status",
        "Elbow_Angle",
        "Elbow_Status",
        "Wrist_Angle",
        "Wrist_Status",
        "Neck_Angle",
        "Neck_Status",
        "Shoulder_Angle",
        "Shoulder_Status",
        "Torso_Angle",
        "Torso_Status",
        "BadAngles",
        "PostureCategory"
    ]

    average_header = [
        "Period_Start",
        "Period_End",
        "Duration_Minutes",
        "Avg_Knee_Angle",
        "Avg_Hip_Angle",
        "Avg_Elbow_Angle",
        "Avg_Wrist_Angle",
        "Avg_Neck_Angle",
        "Avg_Shoulder_Angle",
        "Avg_Torso_Angle",
        "Avg_Score"
    ]

    # create file with headers if it doesn't exist
    if not os.path.exists(excel_path):
        wb = Workbook()
        ws = wb.active
        ws.append(header)
        
        # Create a second sheet for 10-minute averages
        ws_avg = wb.create_sheet("10-Minute Averages")
        ws_avg.append(average_header)
        
        wb.save(excel_path)

    # start time for seconds counter (starts at 0)
    start_time = time.time()
    
    # Data structures for 10-minute averaging
    angle_buffer = {
        "knee": [],
        "hip": [],
        "elbow": [],
        "wrist": [],
        "neck": [],
        "shoulder": [],
        "torso": [],
        "score": []
    }
    last_average_time = time.time()
    ten_minutes = 600  # 10 minutes in seconds

    def alarm_beep():
        # keep beeping while alarm_active is True; stops when main loop clears alarm_active
        while alarm_active:
            winsound.Beep(1000, 300)
            time.sleep(0.25)
    while cap.isOpened():
        ret, frame = cap.read()
        if not ret:
            print("ไม่สามารถเปิดกล้องได้")
            break

        # BGR -> RGB
        img_rgb = cv2.cvtColor(frame, cv2.COLOR_BGR2RGB)
        img_rgb.flags.writeable = False
        results = pose.process(img_rgb)
        img_rgb.flags.writeable = True
        frame = cv2.cvtColor(img_rgb, cv2.COLOR_RGB2BGR)

        if results.pose_landmarks:
            landmarks = results.pose_landmarks.landmark

            # ดึงพิกัดที่จำเป็น
            def get_point(idx):
                return [landmarks[idx].x, landmarks[idx].y]

            # ------------------- คำนวณมุม -------------------
            knee_angle = calculate_angle(get_point(mp_pose.PoseLandmark.RIGHT_HIP.value),
                                         get_point(mp_pose.PoseLandmark.RIGHT_KNEE.value),
                                         get_point(mp_pose.PoseLandmark.RIGHT_ANKLE.value))

            hip_angle = calculate_angle(get_point(mp_pose.PoseLandmark.RIGHT_SHOULDER.value),
                                        get_point(mp_pose.PoseLandmark.RIGHT_HIP.value),
                                        get_point(mp_pose.PoseLandmark.RIGHT_KNEE.value))

            elbow_angle = calculate_angle(get_point(mp_pose.PoseLandmark.RIGHT_SHOULDER.value),
                                          get_point(mp_pose.PoseLandmark.RIGHT_ELBOW.value),
                                          get_point(mp_pose.PoseLandmark.RIGHT_WRIST.value))

            wrist_angle = calculate_angle(get_point(mp_pose.PoseLandmark.RIGHT_ELBOW.value),
                                          get_point(mp_pose.PoseLandmark.RIGHT_WRIST.value),
                                          get_point(mp_pose.PoseLandmark.RIGHT_WRIST.value))  # ใช้เป็น reference

            shoulder_angle = calculate_angle(get_point(mp_pose.PoseLandmark.RIGHT_ELBOW.value),
                                            get_point(mp_pose.PoseLandmark.RIGHT_SHOULDER.value),
                                            get_point(mp_pose.PoseLandmark.RIGHT_HIP.value))

            neck_angle = calculate_angle(get_point(mp_pose.PoseLandmark.NOSE.value),
                                         get_point(mp_pose.PoseLandmark.RIGHT_SHOULDER.value),
                                         get_point(mp_pose.PoseLandmark.RIGHT_HIP.value))

            torso_angle = calculate_angle(get_point(mp_pose.PoseLandmark.RIGHT_SHOULDER.value),
                                          get_point(mp_pose.PoseLandmark.RIGHT_HIP.value),
                                          get_point(mp_pose.PoseLandmark.RIGHT_KNEE.value))

            # ------------------- ตรวจเกณฑ์ -------------------
            status = []
            score = 0

            if 90 <= knee_angle <= 100:
                status.append("Knee OK")
                score += 1
            else:
                status.append("Knee Bad")

            if 90 <= hip_angle <= 100:
                status.append("Hip OK")
                score += 1
            else:
                status.append("Hip Bad")

            if 90 <= elbow_angle <= 120:
                status.append("Elbow OK")
                score += 1
            else:
                status.append("Elbow Bad")

            if 9 <= wrist_angle <= 10 :  # ข้อมือ ±10
                status.append("Wrist OK")
                score += 1
            else:
                status.append("Wrist Bad")

            if neck_angle <= 15:
                status.append("Neck OK")
                score += 1
            else:
                status.append("Neck Bad")

            if shoulder_angle <= 20:
                status.append("Shoulder OK")
                score += 1
            else:
                status.append("Shoulder Bad")

            if 100 <= torso_angle <= 110:
                status.append("Torso OK")
                score += 1
            else:
                status.append("Torso Bad")
                
            # Trigger alarm when score < 4; stop only when score >= 4
            if score < 3 :
                if not alarm_active:
                    alarm_active = True
                    threading.Thread(target=alarm_beep, daemon=True).start()
                if not notification_shown:
                    notification_shown = True
                    threading.Thread(target=lambda: toaster.show_toast(
                        "Poor Posture Alert",
                        f"Your posture needs adjustment!\nScore: {score}/7",
                        duration=5,
                        threaded=True
                    ), daemon=True).start()
                status.append("ALARM: Low Score!")
            else:
                alarm_active = False
                notification_shown = False
            # --- export row to Excel ---
            try:
                # timestamp and seconds since start (start at 0)
                timestamp = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                seconds = int(time.time() - start_time)

                # angle values and statuses
                angles = [
                    (knee_angle, "OK" if "Knee OK" in status else "Bad"),
                    (hip_angle, "OK" if "Hip OK" in status else "Bad"),
                    (elbow_angle, "OK" if "Elbow OK" in status else "Bad"),
                    (wrist_angle, "OK" if "Wrist OK" in status else "Bad"),
                    (neck_angle, "OK" if "Neck OK" in status else "Bad"),
                    (shoulder_angle, "OK" if "Shoulder OK" in status else "Bad"),
                    (torso_angle, "OK" if "Torso OK" in status else "Bad")
                ]

                angle_names = ["Knee","Hip","Elbow","Wrist","Neck","Shoulder","Torso"]
                bad_angles = [name for (name, s) in zip(angle_names, angles) if s[1] == "Bad"]

                # posture category mapping
                if 1 <= score <= 2:
                    category = "Risk"
                elif 3 <= score <= 5:
                    category = "OK"
                elif 6 <= score <= 7:
                    category = "Safe"
                else:
                    category = "Risk"

                row = [timestamp, seconds, score]
                # append each angle value and its status
                for ang_val, ang_stat in angles:
                    row.append(round(float(ang_val), 2))
                    row.append(ang_stat)

                row.append(",".join(bad_angles))
                row.append(category)

                # Collect data for 10-minute averaging
                angle_buffer["knee"].append(knee_angle)
                angle_buffer["hip"].append(hip_angle)
                angle_buffer["elbow"].append(elbow_angle)
                angle_buffer["wrist"].append(wrist_angle)
                angle_buffer["neck"].append(neck_angle)
                angle_buffer["shoulder"].append(shoulder_angle)
                angle_buffer["torso"].append(torso_angle)
                angle_buffer["score"].append(score)

                # Check if 10 minutes have passed and record averages
                current_time = time.time()
                if current_time - last_average_time >= ten_minutes:
                    try:
                        # Calculate averages
                        if angle_buffer["knee"]:  # ensure buffer has data
                            avg_knee = sum(angle_buffer["knee"]) / len(angle_buffer["knee"])
                            avg_hip = sum(angle_buffer["hip"]) / len(angle_buffer["hip"])
                            avg_elbow = sum(angle_buffer["elbow"]) / len(angle_buffer["elbow"])
                            avg_wrist = sum(angle_buffer["wrist"]) / len(angle_buffer["wrist"])
                            avg_neck = sum(angle_buffer["neck"]) / len(angle_buffer["neck"])
                            avg_shoulder = sum(angle_buffer["shoulder"]) / len(angle_buffer["shoulder"])
                            avg_torso = sum(angle_buffer["torso"]) / len(angle_buffer["torso"])
                            avg_score = sum(angle_buffer["score"]) / len(angle_buffer["score"])

                            # Get time info
                            period_end = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                            period_start_dt = datetime.datetime.now() - datetime.timedelta(seconds=600)
                            period_start = period_start_dt.strftime("%Y-%m-%d %H:%M:%S")

                            # Create average row
                            avg_row = [
                                period_start,
                                period_end,
                                10,
                                round(avg_knee, 2),
                                round(avg_hip, 2),
                                round(avg_elbow, 2),
                                round(avg_wrist, 2),
                                round(avg_neck, 2),
                                round(avg_shoulder, 2),
                                round(avg_torso, 2),
                                round(avg_score, 2)
                            ]

                            # Write to the average sheet
                            wb = load_workbook(excel_path)
                            if "10-Minute Averages" not in wb.sheetnames:
                                ws_avg = wb.create_sheet("10-Minute Averages")
                                ws_avg.append(average_header)
                            else:
                                ws_avg = wb["10-Minute Averages"]
                            
                            # Append the average row
                            ws_avg.append(avg_row)
                            
                            # Apply yellow highlighting to average value cells (columns D to K, the last row)
                            yellow_fill = PatternFill(start_color="FFFF00", end_color="FFFF00", fill_type="solid")
                            last_row = ws_avg.max_row
                            for col in range(4, 12):  # Columns D to K (avg values)
                                ws_avg.cell(row=last_row, column=col).fill = yellow_fill
                            
                            wb.save(excel_path)

                            # Reset buffer and timer
                            angle_buffer = {
                                "knee": [],
                                "hip": [],
                                "elbow": [],
                                "wrist": [],
                                "neck": [],
                                "shoulder": [],
                                "torso": [],
                                "score": []
                            }
                            last_average_time = current_time
                    except Exception:
                        # don't interrupt main loop for logging errors
                        pass

                wb = load_workbook(excel_path)
                ws = wb.active
                ws.append(row)
                wb.save(excel_path)
            except Exception:
                # don't interrupt main loop for logging errors
                pass
            status.append(f"Overall Score: {score}/7")
            # วาด skeleton
            mp_drawing.draw_landmarks(frame, results.pose_landmarks, mp_pose.POSE_CONNECTIONS)

            # แสดงผลบนหน้าจอ
            y0 = 30
            for i, s in enumerate(status):
                cv2.putText(frame, s, (10, y0 + i*25), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0,255,0) if "OK" in s else (0,0,255), 2)
                cv2.putText(frame, s, (10, y0 + i*25), cv2.FONT_HERSHEY_SIMPLEX, 0.7, (0,255,0) if "OK" in s or "Overall Score" in s else (0,0,255), 2)

        # แสดงภาพ
        cv2.imshow("Ergonomics Pose Detector", frame)
        if cv2.waitKey(1) & 0xFF == ord('q'):
            break

cap.release()
cv2.destroyAllWindows()
